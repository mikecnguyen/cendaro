{% extends "base.html" %}

{% block head %}
    <!-- Custom styles for this page -->
    <link rel="stylesheet" href="/static/main/css/map-style.css">
{% endblock head %}

{% block content %}
    <!-- Search and filters placed right under the nav bar -->
    <section class="search-input">
      <div class="search-input-wrapper input-group">
        <span class="input-group-addon" id="geoFindMe-btn" onclick="geoFindMe()"><i class="fa fa-location-arrow" aria-hidden="true"></i></span>
        <input type="text" id="address-autocomplete" class="form-control" placeholder="City or zip code" style="font-size: 12.5px;" aria-describedby="basic-addon1">
        <span class="input-group-addon search-icon" id="address-search"><i class="fa fa-search" aria-hidden="true"></i></span>
      </div>
      <div class="search-filters">
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="listing-type-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Listing type
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="listing-type-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">For sale</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">For rent</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="price-range-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Price range
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="price-range-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$10,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$50,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$100,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$150,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$200,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$250,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$300,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$400,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">$500,000+</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="bed-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Beds
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="bed-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Any</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Studio</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">1</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">2</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">3+</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="bath-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Baths
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="bath-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Any</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">1+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">2+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">3+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">4+</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="sqft-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Square feet
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="sqft-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Any</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#"><1,000</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">1,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">2,000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">3,000+</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button class="btn btn-custom dropdown-toggle search-filters-btn" type="button" id="year-built-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
            Year built
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu dropdown-custom" aria-labelledby="year-built-dropdown">
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Any</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">Before 1980</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">1980+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">2000+</a></li>
            <li class="dropdown-search-item"><a class="search-item-link" href="#">New</a></li>
          </ul>
        </div>
      </div>
    </section>
    <!-- Beginning of body container -->
    <div class="container-custom">
      <section class="main-display">
        <div class="map-display" id="map-display">
        </div>

        <div class="property-display">
          <div class="property-display-top" id="property-city-display"></div>
          <div class="property-display-group">
            {% if home_list %}
              {% for home in home_list %}
                <div class="property-display-item">
                  <div class="property-display-wrapper" style="background-image: url(/static/main/img/homes/{{home.full_addr}}/{{home.image.0}});">
                    <div class="property-photo-caption">
                      <div class="property-photo-status">{{home.property_type}} for {{home.property_status}}</div>
                      <div class="property-photo-spec">
                        <span class="property-photo-spec-price">${{home.price}}</span>
                        <span class="property-photo-spec-details">{{home.bed}} bed . </span>
                        <span class="property-photo-spec-details">{{home.bath}} bath . </span>
                        <span class="property-photo-spec-details">{{home.sqft}} sqft</span>
                      </div>
                      <div class="property-photo-addr">{{home.address}}, {{home.city}}, {{home.state}}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/saigon-d1.jpg);"><div class="topcities-title">Ho Chi Minh City</div></div>
              </div>
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/hanoi_skyline.jpg);"><div class="topcities-title">Ha Noi</div></div>
              </div>
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/danang-skyline.jpg);"><div class="topcities-title">Da Nang</div></div>
              </div>
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/vungtau-skyline.jpg);"><div class="topcities-title">Vung Tau</div></div>
              </div>
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/nhatrang-skyline.jpg);"><div class="topcities-title">Nha Trang</div></div>
              </div>
              <div class="property-display-item">
                <div class="property-display-wrapper" style="background-image: url(/static/main/img/city-skyline/cantho-skyline.jpeg);"><div class="topcities-title">Can Tho</div></div>
              </div>
            {% endif %}
          </div>
        </div>
      </section>
    </div>
{% endblock content %}

{% block script %}
  <script>
    function initMap(latitude, longitude) {
      //var nyc = {lat: 40.7128, lng: -74.0061};
      var location = {lat: latitude, lng: longitude};
      var myOptions = {
        center: location,
        mapTypeId: 'roadmap',
        mapTypeControl: false,
        panControl: false,
        zoomControl: true,
        streetViewControl: false,
        zoom: 14
      };
      var map = new google.maps.Map(document.getElementById('map-display'), myOptions);
      var marker = new google.maps.Marker({
        position: location,
        map: map
      });
      // Resize stuff...
      google.maps.event.addDomListener(window, "resize", function() {
        var center = map.getCenter();
        google.maps.event.trigger(map, "resize");
        map.setCenter(center); 
      });
    };

    function geoFindMe() {
      if (!navigator.geolocation){
        alert("Geolocation is not supported by your browser.");
        return;
      }

      function success(position) {
        var latitude  = position.coords.latitude;
        var longitude = position.coords.longitude;
        var loc = latitude + ',' + longitude;
        var url = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + loc + "&sensor=true";
        //document.getElementById('address-autocomplete').value = addressFill;
        $.get(url, function(data){
            var city = data.results[0].address_components[3].long_name;
            var state = data.results[0].address_components[5].short_name;
            var addressFill = city + ", " + state;
            //document.getElementById('address-autocomplete').value = addressFill;
            //document.getElementById('property-city-display').value = city;
            $('#address-autocomplete').val(addressFill);
            $('#property-city-display').text(state + ' - ' + city + ' homes');
        });
        initMap(latitude, longitude); // Automatically display map with center as this location
      };

      function error() {
        alert("Unable to retrieve your location");
      };

      navigator.geolocation.getCurrentPosition(success, error);
    };

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geoLocate() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          var circle = new google.maps.Circle({
            center: geolocation,
            radius: position.coords.accuracy
          });
          autocomplete.setBounds(circle.getBounds());
        });
      }
    };

    function initAutocomplete() {
      var map = new google.maps.Map(document.getElementById('map-display'), {
        center: {lat: -34.397, lng: 150.644},
        zoom: 14,
        mapTypeId: 'roadmap',
        panControl: false,
        streetViewControl: false,
        rotateControl: false
      });

      // Create the search box and link it to the UI element.
      var input = document.getElementById('address-autocomplete');
      var searchBox = new google.maps.places.SearchBox(input);
      //map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

      // Bias the SearchBox results towards current map's viewport.
      map.addListener('bounds_changed', function() {
        searchBox.setBounds(map.getBounds());
      });

      var markers = [];
      // Listen for the event fired when the user selects a prediction and retrieve
      // more details for that place.
      searchBox.addListener('places_changed', function() {
        var places = searchBox.getPlaces();

        if (places.length == 0) {
          return;
        }

        // Clear out the old markers.
        markers.forEach(function(marker) {
          marker.setMap(null);
        });
        markers = [];

        // For each place, get the icon, name and location.
        var bounds = new google.maps.LatLngBounds();
        places.forEach(function(place) {
          if (!place.geometry) {
            console.log("Returned place contains no geometry");
            return;
          }
          var icon = {
            url: place.icon,
            size: new google.maps.Size(71, 71),
            origin: new google.maps.Point(0, 0),
            anchor: new google.maps.Point(17, 34),
            scaledSize: new google.maps.Size(25, 25)
          };

          // Create a marker for each place.
          markers.push(new google.maps.Marker({
            map: map,
            icon: icon,
            title: place.name,
            position: place.geometry.location
          }));

          if (place.geometry.viewport) {
            // Only geocodes have viewport.
            bounds.union(place.geometry.viewport);
          } else {
            bounds.extend(place.geometry.location);
          }
        });
        map.fitBounds(bounds);
      });
    };

  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTOeyBX-lPL5p0YhWboo8XLg9fGvhhTDo&libraries=places&callback=initAutocomplete"
    async defer></script>


  <script>
      $(document).ready(function(){
        geoFindMe();
      });
  </script>
{% endblock script %}